tests.results.out = .gab.channel()

module = {
  tests.results.out,
  tests.covers,
  tests.should,
}

\tests.when :def! (module ?, do cb:
  t = self

  .gab.fiber do: cb(t) end

  self
end)

tests.compare.results.t = { t, result, a, b, cmp }?

\tests.compare.dodisplay :defcase! {
  .true = do result:
    '{result:t:tests.covers} [PASS]: {result:t:tests.should} {result:a} {result:cmp} {result:b}':print
  end,
  .false = do result:
    '{result:t:tests.covers} [FAIL]: {result:t:tests.should} {result:a} {result:cmp} {result:b}':print
  end,
}

\tests.results.display :def! (tests.compare.results.t, do:
  self:result :tests.compare.dodisplay self
end)

\tests.compare :def!('gab.message', 'gab.block', do a, b, t:
  result = self(a,b)
  { t, result, a, b, cmp = self }
end)

\tests.expect :def! (module ?, do a, cmp, b:
  self:tests.results.out <! cmp:tests.compare(a, b, self)
end)

.gab.fiber do:
  tests.results.out :each \tests.results.display
end

module
